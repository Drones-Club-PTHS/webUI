<!DOCTYPE html>
<html>

<head>
	<meta charset='utf-8'>
	<title>Drenes club - Visit table</title>
	<meta name='viewport' content='width=device-width, initial-scale=1'>
	<link rel="stylesheet" href="../src/table.css">
	<style>
		#sendGithubStatus {
			display: inline-block;
			width: 2em;
		}
	</style>
	<script>
		async function sendToGithub() {
			const status = document.getElementById("sendGithubStatus");
			status.innerHTML = "--";
			const res = await window.studentsFile.commit(true);
			if (res.commit) {
				status.innerHTML = "Ok";
			} else {
				console.error("Commit ERROR", res)
				status.innerHTML = ":(";
			}
		}
	</script>
</head>

<body>
	<table id="gitTable" class="table"></table>
	<script type="module">
		import config from "../config.json" with { type: "json" };
		import * as github from "../src/github.js";
		import { GitTable } from "./git_table.mjs";
		import { UpdatesHandler } from "../src/updates_handler.js";
		
		window.gitTable = GitTable(document.querySelector("#gitTable"));

		function getStudentsJson() {
			return github.getJsonFile(localStorage.getItem("github-token"), config.clubs[parseInt(localStorage.getItem("club-index"))].studentsFileUrl);
		}

		async function sendDataUpdates(dataUpdates) {
			return github.updateJsonFile(dataUpdates,
					config.clubs[parseInt(localStorage.getItem("club-index"))].studentsFileUrl,
					localStorage.getItem("github-token"),
					localStorage.getItem("github-name"),
					localStorage.getItem("github-email"))
			.then((newJson) => {
				window.studentsJson = newJson;
			})
		}

		function rerender(UIupdates) {
			getStudentsJson().then(res => {
				window.stJson = res;
				window.gitTable.generate(window.stJson);
				UIupdates.forEach(upd => {upd(table)});
			})
		}

		window.updateHandler = new UpdatesHandler(sendDataUpdates, rerender);

		getStudentsJson().then(res => {
			window.stJson = res;
			window.gitTable.generate(window.stJson);
		})
	</script>
</body>

</html>
