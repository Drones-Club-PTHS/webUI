<!DOCTYPE html>
<html>

<head>
	<meta charset='utf-8'>
	<title>Drenes club - Visit table</title>
	<meta name='viewport' content='width=device-width, initial-scale=1'>
	<script src="./src/clear_localStorage.js"></script>
	<link rel="stylesheet" href="./src/table.css">
	<style>
		.visit-cell {
			user-select: none; 
		}
	</style>
</head>

<body>
	<table id="visitTable" class="table"></table>
	<script type="module">
		import config from "./config.json" with { type: "json" };
		import * as github from "./src/github.js";
		import { generateVisitTableContent } from "./test_table.mjs";
		import { UpdatesHandler } from "./src/updates_handler.js";

		async function sendDataUpdates(dataUpdates) {
			return github.updateJsonFile(dataUpdates,
					config.clubs[parseInt(localStorage.getItem("club-index"))].studentsFileUrl,
					localStorage.getItem("github-token"),
					localStorage.getItem("github-name"),
					localStorage.getItem("github-email"))
			.then((newJson) => {
				window.studentsJson = newJson;
			})
		}

		function rerender(UIupdates) {
			const table = document.querySelector("#visitTable");
			const date = new Date();
			const dateString = date.toLocaleDateString('ru-RU', {
				year: "numeric",
				month: "2-digit",
				day: "2-digit"
			})
			generateVisitTableContent(window.studentsJson, table, [dateString]);
			UIupdates.forEach(upd => {upd(table)});
		}

		window.updateHandler = new UpdatesHandler(sendDataUpdates, rerender);

		function getStudentsJson() {
			return github.getJsonFile(localStorage.getItem("github-token"), config.clubs[parseInt(localStorage.getItem("club-index"))].studentsFileUrl);
		}

		getStudentsJson().then(res => {
			window.studentsJson = res;
			rerender([]);
		})
	</script>
</body>

</html>
