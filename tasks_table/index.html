<!DOCTYPE html>
<html>

<head>
	<meta charset='utf-8'>
	<title>Drenes club - Tasks table</title>
	<meta name='viewport' content='width=device-width, initial-scale=1'>
	<link rel="stylesheet" href="../0_table/table.css">
    <script>
        async function sendToGithub() {
			await window.studentsFile.commit(true);
			await window.tasksFile.commit(true);			
        }

		function rerender() {
			window.studentsTable.tableGenerator.generateTableContent();
			window.tasksTable.tableGenerator.generateTableContent();
		}

		function addNewTask() {
			let id = prompt("Task id:\n");
			let name = prompt("Task name:\n");
			if (id && name) {
				window.tasksFile.conent.push({"id": id, "name": name});
				rerender();
			}
		}
    </script>
	<style>
		.table {
			display: inline-block;
			margin: 1em;
		}
		.table td.current_student {
			color: red;
		}
		.table td.title {
			color: red;
		}
	</style>
</head>

<body>
	<button onclick="sendToGithub()" style="color: red;">Send to GitHub</button>
	<button onclick="rerender()">Rerender tables</button>
	<button onclick="addNewTask()">New Task</button>
	<br/>
	<table id="studentsTable" class="table"></table>
	<table id="tasksTable" class="table"></table>
	<script>
		window.studentsTable = document.getElementById("studentsTable");
		window.tasksTable = document.getElementById("tasksTable");

		window.addEventListener("keydown", (event) => {
			switch (event.key) {
				case "ArrowLeft":
					if (window.studentsTable.querySelector("td.current_student")) {
						window.studentsTable.querySelector("td.current_student").focus();
					} else {
						window.studentsTable.firstChild.click();
					}
					break;
				case "ArrowRight":
					window.tasksTable.lastChild.click();
					break;
			}
		});
	</script>
	<script type="module">
		import { GitHubFile } from "../0_github/github_files.mjs";
		import { StudentsData } from "../0_parse_data/students_data.js";
		import { TableGenerator } from "../0_table/tableGenerator.mjs";
		import * as taskTableFunctions from "./tasks_table.mjs";
		import * as studentsTableFunctions from "./students_table.mjs";
		
		window.tasksTable.addEventListener("click", taskTableFunctions.tableClickEvent);
		window.tasksTable.addEventListener("keydown", taskTableFunctions.keyEvent);
		window.studentsTable.addEventListener("click", studentsTableFunctions.tableClickEvent);
		window.studentsTable.addEventListener("keydown", studentsTableFunctions.keyEvent);

		window.studentsFile = new GitHubFile("students.json");
		window.tasksFile = new GitHubFile("tasks.json");
		const fetchStudents = window.studentsFile.fetch().then(() => {
			window.students = new StudentsData(window.studentsFile);
		})
		const fetchTasks = window.tasksFile.fetch();

		window.data = {
			currentStudent: undefined,
			get tasks() { return window.tasksFile.content },
			get studentsData() { return window.students }
		}

		Promise.all([
			fetchStudents,
			fetchTasks
		]).then((results) => {
			window.studentsTable.tableGenerator = new TableGenerator(window.data, studentsTableFunctions.functions, window.studentsTable);
			window.tasksTable.tableGenerator = new TableGenerator(window.data, taskTableFunctions.functions, window.tasksTable);
			window.studentsTable.tableGenerator.generateTableContent();
			window.tasksTable.tableGenerator.generateTableContent();
		});
	</script>
</body>

</html>
