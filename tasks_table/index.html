<!DOCTYPE html>
<html>

<head>
	<meta charset='utf-8'>
	<title>Drenes club - Tasks table</title>
	<meta name='viewport' content='width=device-width, initial-scale=1'>
	<script src="../src/clear_localStorage.js"></script>
	<link rel="stylesheet" href="../src/table.css">
	<script>
		function addNewTask() {
			let id = prompt("Task id:\n");
			let name = prompt("Task name:\n");
			if (id && name) {
				window.tasksFile.content.push({"id": id, "name": name});
				rerender();
			}
		}
	</script>
	<style>
		.table {
			display: inline-block;
			margin: 1em;
		}
		.table td.current-student {
			color: red;
		}
	</style>
</head>

<body>
	<button onclick="addNewTask()">New Task</button>
	<br/>
	<table id="studentsTable" class="table"></table>
	<table id="tasksTable" class="table"></table>
	<script>
		window.studentsTable = document.getElementById("studentsTable");
		window.tasksTable = document.getElementById("tasksTable");

		window.addEventListener("keydown", (event) => {
			switch (event.key) {
				case "ArrowLeft":
					if (window.studentsTable.querySelector("td.current_student")) {
						window.studentsTable.querySelector("td.current_student").focus();
					} else {
						window.studentsTable.firstChild.click();
					}
					break;
				case "ArrowRight":
					window.tasksTable.lastChild.click();
					break;
			}
		});
	</script>
	<script type="module">
		import config from "../config.json" with { type: "json" };
		import * as github from "../src/github.js";
		import { TasksTable } from "./tasks_table.mjs";
		import { StudentsTable } from "./students_table.mjs";
		import { UpdatesHandler } from "../src/updates_handler.js";

		window.studentsTable = StudentsTable(document.querySelector("#studentsTable"));
		window.tasksTable = TasksTable(document.querySelector("#tasksTable"));

		function getStudentsJson() {
			return github.getJsonFile(localStorage.getItem("github-token"), config.clubs[parseInt(localStorage.getItem("club-index"))].studentsFileUrl);
		}

		function getTasksJson() {
			return github.getJsonFile(localStorage.getItem("github-token"), config.clubs[parseInt(localStorage.getItem("club-index"))].tasksFileUrl);
		}

		async function sendDataUpdates(dataUpdates) {
			return github.updateJsonFile(dataUpdates,
					config.clubs[parseInt(localStorage.getItem("club-index"))].studentsFileUrl,
					localStorage.getItem("github-token"),
					localStorage.getItem("github-name"),
					localStorage.getItem("github-email"))
			.then((newJson) => {
				window.stJson = newJson;
			})
		}

		function rerender(UIupdates) {
			tasksTable.generate(tskJson, currentStudent);
			studentsTable.generate(stJson, currentStudent);
			UIupdates.forEach(upd => {
				if (upd.student.id == currentStudent.id) {
					upd(tasksTable)
				}});
		}

		window.updateHandler = new UpdatesHandler(sendDataUpdates, rerender);

		Promise.all([
			getStudentsJson(),
			getTasksJson()
		]).then(res => {
			const [stJson, tskJson] = res;
			window.stJson = stJson;
			window.tskJson = tskJson;
			window.currentStudent = stJson[0];
			rerender([])
		})
	</script>
</body>

</html>
